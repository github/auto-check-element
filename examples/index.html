<!DOCTYPE html>
<html lang="en">
  <head>
    <title>&lt;auto-check&gt; element</title>
    <style>
      auto-check {
        display: block;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>auto-check-element</h1>
      <h2>Simple form</h2>
      <p>Input 422 for an error response.</p>
      <p id="success1" class="success" hidden>Your submission was successful</p>
      <form>
        <p>All fields marked with * are required</p>

        <label for="simple-field">Desired username*:</label>
        <auto-check csrf="foo" src="/demo" required>
          <input id="simple-field" autofocus name="foo" required />
          <code aria-live="polite" class="state"></code>
        </auto-check>
        <button value="1" name="form">submit</button>
      </form>

      <h2>Form that has custom validity messages</h2>
      <p>Input 422 for an error response.</p>
      <p id="success2" class="success" hidden>Your submission was successful</p>
      <form id="custom">
        <p>All fields marked with * are required</p>

        <label for="custom-field">Desired username*:</label>
        <auto-check csrf="foo" src="/demo" required>
          <input id="custom-field" autofocus class="json" name="foo" required />
          <code aria-live="polite" class="state"></code>
        </auto-check>
        <button value="2" name="form">submit</button>
      </form>
    </main>

    <script>
      let successN = new URL(window.location).searchParams.get('form')
      if (successN) document.getElementById(`success${successN}`).hidden = false
      let focusedInput
      const nativeFetch = window.fetch
      const fakeFetch = function (_, options) {
        const path = `https://httpbin.org/status/${options.body.get('value') === '422' ? '422' : '200'}`
        return nativeFetch(path, options)
      }
      window.fetch = fakeFetch

      for (const form of document.forms) {
        const formInput = form.querySelector('input')
        const button = form.querySelector('button')
        const state = form.querySelector('.state')

        formInput.addEventListener('focus', () => {
          focusedInput = formInput
        })

        form.addEventListener('auto-check-start', () => {
          if (form.id === 'custom') {
            const {setValidity} = event.detail
            setValidity('ðŸ” Checking validity...')
          }
          state.textContent = 'loading'
        })
        form.addEventListener('auto-check-success', event => {
          state.textContent = 'succeeded'
        })
        form.addEventListener('auto-check-error', event => {
          if (form.id === 'custom') {
            const {setValidity} = event.detail
            setValidity('ðŸš« Something went wrong.')
          }
          state.textContent = 'error'
        })
        form.addEventListener('auto-check-complete', () => {
          if (state.textContent === 'loading') state.textContent = ''
        })
      }
    </script>

    <script type="module" src="https://unpkg.com/@github/auto-check-element@latest"></script>
    <!-- <script type="module" src="../dist/index.js" defer></script> -->
  </body>
</html>
